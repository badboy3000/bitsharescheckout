/*! bitsharescheckout - v1.0.0-SNAPSHOT - 2015-07-24
 * https://github.com/sidhujag/bitsharescheckout
 * Copyright (c) 2015 Jag Sidhu;
 * Licensed 
 */
function ajaxLookup(serializedData){$.ajax({url:"callbacks/callback_lookup.php",type:"post",dataType:"json",timeout:15e3,data:serializedData,beforeSend:function(){},complete:function(){globalInitDialog.close(),$("#payNow").focus()},error:function(jqXHR,textStatus){var res=textStatus;""!==jqXHR.responseText&&(res=jqXHR.responseText),noty({text:res,type:"error"}),btsUpdateUIPaymentFail()},success:function(response){if(response)if(response.error)noty({text:response.error,type:"error"}),btsUpdateUIPaymentFail();else{if(response.countdown_time){var countdownTime=parseInt(response.countdown_time,0);countdownTime>0?btsStartPaymentCountdown(countdownTime):btsCancelPaymentByCountdown()}response.primaryTickerAssets&&response.secondaryTickerAssets&&btsStartTicker(response.primaryTickerAssets,response.secondaryTickerAssets),0===globalTotal&&""===globalAsset&&(globalTotal=response.total,globalAsset=response.asset,$("#amount").val(globalTotal+" "+globalAsset))}else btsUpdateUIPaymentFail()}})}function ajaxPay(serializedData){$.ajax({url:"callbacks/callback_pay.php",type:"post",dataType:"json",timeout:15e3,data:serializedData,beforeSend:function(){globalLoadingDialog.open()},complete:function(){globalLoadingDialog.close()},error:function(jqXHR,textStatus){var res=textStatus;""!==jqXHR.responseText&&(res=jqXHR.responseText),noty({text:res,type:"error"}),btsUpdateUIPaymentFail()},success:function(response){var textresponse="Payment processing...";response?response.error?(noty({text:response.error,type:"error"}),btsUpdateUIPaymentFail()):response.url&&(noty({text:textresponse,type:"success"}),response.url.length>1&&(window.location.href=response.url),btsStartPaymentTracker(serializedData),btsShowPaymentStatus()):btsUpdateUIPaymentFail()}})}function ajaxCancel(myurl,serializedData){$.ajax({url:myurl,type:"post",dataType:"json",timeout:15e3,data:serializedData,beforeSend:function(){globalLoadingDialog.open()},complete:function(){globalLoadingDialog.close()},error:function(jqXHR,textStatus){var res=textStatus;""!==jqXHR.responseText&&(res=jqXHR.responseText),noty({text:res,type:"error"}),btsUpdateUIReturnError()},success:function(response){if(response){if(response.fallbackURL){var textresponse="Returning to checkout...If you are not redirected click <a href='"+response.fallbackURL+"'>here</a>";noty({text:textresponse,type:"success",timeout:!1})}response.error?noty({text:response.error,type:"error"}):response.url&&(window.location.href=response.url)}}})}function ajaxSuccess(myurl,serializedData){$.ajax({url:myurl,type:"post",timeout:15e3,dataType:"json",data:serializedData,beforeSend:function(){globalLoadingDialog.open()},complete:function(){globalLoadingDialog.close()},error:function(jqXHR,textStatus){var res=textStatus;""!==jqXHR.responseText&&(res=jqXHR.responseText),noty({text:res,type:"error"}),btsUpdateUIReturnError()},success:function(response){if(response){if(response.fallbackURL){var textresponse="Returning to checkout...If you are not redirected click <a href='"+response.fallbackURL+"'>here</a>";noty({text:textresponse,type:"success",timeout:!1})}response.error?noty({text:response.error,type:"error"}):response.url&&(window.location.href=response.url)}}})}function ajaxScanChain(serializedData){$.ajax({url:"callbacks/callback_verifysingleorder.php",type:"post",timeout:15e3,dataType:"json",data:serializedData,beforeSend:function(){},complete:function(){},error:function(jqXHR,textStatus){var res=textStatus;""!==jqXHR.responseText&&(res=jqXHR.responseText),noty({text:res,type:"error"})},success:function(response){if(response)if(response.error)noty({text:response.error,type:"error"});else{response.length>0&&$("#paymentStatusTable tbody").empty();for(var totalAmountReceived=0,complete=!1,processing=!1,i=0;response.length>i;i++)processing=!0,("complete"===response[i].status||"overpaid"===response[i].status)&&(complete=!0,processing=!1),totalAmountReceived+=parseFloat(parseFloat(response[i].amount)),$("#paymentStatusTable").find("tbody").append($("<tr>").append($("<td>").text(i+1)).append($("<td>").append($("<a>").attr("class","trxLink").attr("href","bts:Trx/"+response[i].trx_id).text(response[i].trx_id.substr(0,10)+"..."))).append($("<td>").attr("class","text-right").text(parseFloat(response[i].amount).toFixed(2)+" "+response[i].asset)));$("a.trxLink").click(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,window.location.href=$(this).attr("href")}),totalAmountReceived>0&&(globalAmountReceived=totalAmountReceived),complete?(btsPaymentComplete(),clearInterval(globalPaymentTimer),btsUpdateUIFullPayment()):processing&&btsUpdateUIPartialPayment()}}})}function GetURLParameter(sParam){for(var sPageURL=window.location.search.substring(1),sURLVariables=sPageURL.split("&"),i=0;sURLVariables.length>i;i++){var sParameterName=sURLVariables[i].split("=");if(sParameterName[0]===sParam)return sParameterName[1]}}function btsStartTicker(primaryAssets,secondaryAssets){$(".bitsharesticker").bitsharesticker({title:"Bitshares Checkout Live Ticker",source:"callbacks/callback_getfeedprices.php",currencyTemplateSource:"Common-Currency.json",currencyPrimary:primaryAssets,currencySecondary:secondaryAssets})}function btsStartPaymentTracker(serializedData){globalScanInProgress||(btsUpdateUIScan(),globalPaymentTimer&&clearInterval(globalPaymentTimer),ajaxScanChain(serializedData),globalPaymentTimer=setInterval(function(){ajaxScanChain(serializedData)},1e4))}function btsStart(){var accountName=GetURLParameter("accountName"),order_id=GetURLParameter("order_id"),memo=GetURLParameter("memo");$("#accountName").val(accountName),$("#accountNameDisplay").text(accountName),$("#accountNameDisplay").attr("href","bts:"+accountName),$("#order_id").val(order_id),$("#memo").val(memo),$("#payTo").val(accountName);var subject="Bitshares payment URL for order "+memo,url=encodeURIComponent(window.location.href);$("#socialMail").attr("href","mailto:?subject="+subject+"&body="+url),$("#socialGoogle").attr("href","https://plus.google.com/share?url="+url),$("#socialFacebook").attr("href","http://www.facebook.com/sharer.php?m2w&s=100&p[url]="+url+"&p[images][0]=http://bitshares.org/wp-content/uploads/2014/11/bts-logo-white.png&p[title]=Bitshares payment gateway&p[summary]="+subject),$("#socialTwitter").attr("href","http://twitter.com/intent/tweet?source=sharethiscom&text="+subject+"&url="+url),ajaxLookup($("#btsForm").serialize())}function btsShowSuccess(){globalRedirectDialog.open();var countdown=10;globalRedirectCountdownTimer&&clearInterval(globalRedirectCountdownTimer),globalRedirectCountdownTimer=setInterval(function(){countdown--,$("#redirectCountdown").html("You will now be automatically redirected back to the merchant site within "+countdown+" seconds...<br /><br />"),0>=countdown&&(clearInterval(globalRedirectCountdownTimer),ajaxSuccess("callbacks/callback_success.php",$("#btsForm").serialize()))},1e3)}function btsStartPaymentCountdown(countDownTime){$(".paymentCountdown").FlipClock(countDownTime,{clockFace:"MinuteCounter",countdown:!0,callbacks:{stop:function(){globalPaid||btsCancelPaymentByCountdown()}}})}function btsPaymentComplete(){globalPaid=!0,$(".paymentCountdown").stop(),btsShowSuccess()}function btsExportPaymentTableToCSV(){window.location.href="../exportCSV.php?memo="+$("#memo").val()+"&order_id="+$("#order_id").val()}function btsShowPaymentStatus(){$("#exportCSV").removeClass("invisible"),$("#paymentStatus").removeClass("hidden"),btsStartPaymentTracker($("#btsForm").serialize())}function btsUpdateOnChange(){globalScanInProgress&&BootstrapDialog.warning("You have cancelled the current payment scan!"),btsUpdateUIScanClear()}function btsCancelPaymentByCountdown(){noty({text:"This order has expired!",type:"error"}),ajaxCancel("callbacks/callback_cancel.php",$("#btsForm").serialize())}function btsPayClick(){globalPaid?BootstrapDialog.danger("This order has already been paid for!"):globalAmountReceived>0?BootstrapDialog.confirm("There are partial payment(s) on this order. Would you like to pay the remaining balance of "+$("#paymentBalance").text()+"?",function(result){result&&ajaxPay($("#btsForm").serialize())}):ajaxPay($("#btsForm").serialize())}function InitGlobals(){$.noty.defaults.layout="topRight",$.noty.defaults.theme="relax",$.noty.defaults.timeout=1e4,$.noty.defaults.animation.open="animated flipInX",$.noty.defaults.animation.close="animated flipOutX",$.noty.defaults.animation.easing="swing",globalInitDialog=new BootstrapDialog({title:"Initializing",message:"Please wait a moment while we set things up...",autodestroy:!1,closable:!1,buttons:[]}),globalLoadingDialog=new BootstrapDialog({title:"Loading",message:"Please wait a moment...",autodestroy:!1,closable:!1,buttons:[]}),globalInitDialog.open(),globalRedirectDialog=new BootstrapDialog({title:"Payment Complete",message:$("<div></div>").load("template/success.html"),autodestroy:!1,closable:!1,closeByBackdrop:!1,buttons:[{label:"Cancel",cssClass:"btn-primary",action:function(dialogItself){globalRedirectCountdownTimer&&(clearInterval(globalRedirectCountdownTimer),globalRedirectCountdownTimer=null),dialogItself.close()}}]})}function btsUpdateUIDefault(){$("#myForm .fa-robo").removeClass("success fail"),$("#myForm").removeClass("fail animated"),$("#paymentMessage").html("Scanning for payments on the blockchain for this order...<br /><br />"),$("#return").text("Cancel and return to merchant"),$("#paymentProgressOuter").addClass("active");var balance=globalTotal-globalAmountReceived;0>balance&&(balance=0),balance=parseFloat(balance).toFixed(2),$("#paymentBalance").text(balance+" "+globalAsset);var amount=parseFloat(globalAmountReceived).toFixed(2);$("#paymentTotalReceived").text(amount+" "+globalAsset)}function btsUpdateUIPaymentFail(){$("#myForm .fa-robo").removeClass("success").addClass("fail"),$("#myForm").addClass("fail")}function btsUpdateUIScanClear(){globalAmountReceived=0,globalTotal=0,globalAsset="",btsUpdateUIDefault(),globalPaid=!1}function btsUpdateUIScanComplete(){globalNeedScan=!1,globalScanInProgress=!1,$("#paymentMessage").text("Scan complete"),$("#paymentProgressOuter").removeClass("active")}function btsUpdateUIScan(){globalScanInProgress=!0,btsUpdateUIDefault(),$("#paymentProgressOuter").addClass("active"),$("#paymentMessage").html("Scanning for payments on the blockchain for this order...<br /><br />")}function btsUpdateUIPayment(){var amountReceived=parseFloat(globalAmountReceived).toFixed(2),balance=globalTotal-globalAmountReceived;0>balance&&(balance=0),balance=parseFloat(balance).toFixed(2),$("#paymentBalance").text(balance+" "+globalAsset),$("#paymentTotalReceived").text(amountReceived+" "+globalAsset)}function btsUpdateUIPartialPayment(){btsUpdateUIPayment();var paymentmessage="Payment found. You still have a balance. ";paymentmessage+=globalScanInProgress?"Scanning further for any remaining payments...":"Please click 'Scan Again' to keep looking for more payments...",paymentmessage+="<br /><br />",$("#paymentMessage").html(paymentmessage)}function btsUpdateUIFullPayment(){btsUpdateUIPayment(),btsUpdateUIScanComplete(),$("#myForm .fa-robo").removeClass("fail").addClass("success"),$("#myForm").removeClass("fail").removeClass("animated"),$("#return").text("I'm done! Return to merchant"),$("#returnIcon").removeClass("fail").addClass("success shake"),$("#paymentMessage").html("Payment complete...<br /><br />")}function btsUpdateUIReturnError(){$("#returnIcon").removeClass("success").addClass("fail")}$("input[type='text'], input[type='number']").change(function(){btsUpdateOnChange()}),$(".paymentCountdown").click(function(){BootstrapDialog.warning("This is a time sensitive order. The price at which you pay for this order is locked for up to 15 minutes. You must pay and confirm this order within that time or it will be cancelled and you will be redirected back to the merchant site.")}),$("#exportCSV").click(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,btsExportPaymentTableToCSV()}),$("#btsForm").submit(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,btsPayClick()}),$("#paymentStatus").click(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,btsShowPaymentStatus()}),$("#return").click(function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,globalPaid?ajaxSuccess("callbacks/callback_success.php",$("#btsForm").serialize()):BootstrapDialog.confirm("This will cancel your order. Are you sure?",function(result){result&&ajaxCancel("callbacks/callback_cancel.php",$("#btsForm").serialize())})}),function(jQuery){jQuery.fn.bitsharesticker=function(options){function decimalAdjust(type,value,exp){return exp===void 0||0===+exp?Math[type](value):(value=+value,exp=+exp,isNaN(value)||"number"!=typeof exp||0!==exp%1?0/0:(value=(""+value).split("e"),value=Math[type](+(value[0]+"e"+(value[1]?+value[1]-exp:-exp))),value=(""+value).split("e"),+(value[0]+"e"+(value[1]?+value[1]+exp:exp))))}function round10(value,exp){return decimalAdjust("round",value,-1*exp)}function updater(){jQuery.ajax({url:options.source+"?assets="+currencyUniqueList,type:"get",dataType:"json",timeout:15e3,error:function(){firstLoad=!0,jQuery(".bitsharesticker-feed").html("<span><font color='red'>Error!</font> Could not download price data. Trying again in 5 seconds...</span>")},complete:function(){var timeout=firstLoadUpdateInterval;firstLoad||(timeout=options.updateInterval),setTimeout(function(){updater()},1e3*timeout)},success:function(response){if(response){var data=formatJSONCurrencyData(response);if(firstLoad){firstLoad=!1;var myhtml=buildScrollingText(data);jQuery(".bitsharesticker-feed").html(myhtml)}else updateScrollingText(data)}}})}function animationLoop(){var pos=feedsList.position().left;-1*feedsList.width()>pos&&feedsList.css("left",overflowContainer.width()),currentRate>0?feedsList.animate({left:"-=1px"},currentRate,"linear",animationLoop):animationLoop()}function buildCurrencyMap(){var tmpMap=[],currencyMap=[];currencyUniqueList="";var formattedPrimary=options.currencyPrimary.replace(/\s/g,""),currencyPrimaryArray=formattedPrimary.split(",");options.currencySecondary.replace(/\s/g,"");for(var currencySecondaryArray=options.currencySecondary.split(","),i=0;currencyPrimaryArray.length>i;i++){-1===currencyUniqueList.indexOf(currencyPrimaryArray[i])&&(currencyUniqueList+=currencyPrimaryArray[i]+",");for(var j=0;currencySecondaryArray.length>j;j++){-1===currencyUniqueList.indexOf(currencySecondaryArray[j])&&(currencyUniqueList+=currencySecondaryArray[j]+",");var currencyString=currencyPrimaryArray[i]+currencySecondaryArray[j],reverseCurrencyString=currencySecondaryArray[j]+currencyPrimaryArray[i];tmpMap[reverseCurrencyString]||tmpMap[currencyString]||(tmpMap[currencyString]=1,currencyMap.push({primary:currencyPrimaryArray[i],secondary:currencySecondaryArray[j]}))}}return currencyUniqueList.length>0&&(currencyUniqueList=currencyUniqueList.slice(0,-1)),currencyMap}function formatJSONCurrencyData(response){for(var data=[],i=0;response.length>i;i++){var currencyObj=[];currencyObj.open_price=response[i].opening_price?response[i].opening_price:response[i].median_price,currencyObj.median_price=response[i].median_price,data[response[i].asset]=currencyObj}return data}function updateScrollingText(data){var d=new Date;jQuery("#date").text(""+d),jQuery.each(currencyMap,function(key,value){var divKey=value.primary+value.secondary,isoCodeMap=currencyIsoCodes[value.secondary],precision=2;isoCodeMap&&(precision=isoCodeMap.decimal_digits);var median_price=0;"BTS"===value.primary?(median_price=data[value.secondary].median_price,precision=currencyIsoCodes[value.primary].decimal_digits):"BTS"===value.secondary?(median_price=1/data[value.primary].median_price,precision=currencyIsoCodes[value.secondary].decimal_digits):data[value.primary]&&data[value.secondary]&&(median_price=data[value.secondary].median_price/data[value.primary].median_price);var median_priceRounded=round10(median_price,precision),medianRounded=round10(parseFloat(jQuery("#"+divKey+" #value").text()),precision);if(medianRounded!=median_priceRounded){var open_price=0;"BTS"===value.primary?open_price=data[value.secondary].open_price:"BTS"===value.secondary?open_price=1/data[value.primary].open_price:data[value.primary]&&data[value.secondary]&&(open_price=data[value.secondary].open_price/data[value.primary].open_price);var difference=median_price-open_price,pct=round10(100*(difference/open_price),2),symbol="";isoCodeMap&&(symbol=isoCodeMap.symbol);var build=value.primary+"/"+value.secondary+" "+symbol+'<b id="value">'+median_priceRounded+"</b>";difference>0?build+='<b class="up">&nbsp;<b class="change">&nbsp;'+round10(difference,precision)+'</b><b class="pct">&nbsp;('+pct+'%)</b>&nbsp;<i class="fa fa-caret-up"></i></b>':0>difference&&(build+='<b class="down">&nbsp;<b class="change">&nbsp;'+round10(difference,precision)+'</b><b class="pct">&nbsp;('+pct+'%)</b>&nbsp;<i class="fa fa-caret-down"></i></b>'),build+="&nbsp;&nbsp;",jQuery("#"+divKey).html(build)}})}function getCurrencyCodes(){jQuery.ajax({url:options.currencyTemplateSource,type:"get",dataType:"json",timeout:15e3,error:function(){jQuery(".bitsharesticker-feed").html("<span><font color='red'>Error!</font> Could not download Currency template file. Please refresh your browser to try again...</span>")},success:function(response){response&&(currencyIsoCodes=response,setTimeout(function(){updater()},1e3*firstLoadUpdateInterval))}})}function buildScrollingText(data){var build="",d=new Date;return build+="<span><span id='date'>"+(""+d)+"</span>&nbsp;&nbsp;",jQuery.each(currencyMap,function(key,value){var isoCodeMap=currencyIsoCodes[value.secondary],precision=2;isoCodeMap&&(precision=isoCodeMap.decimal_digits),build+='<span id="'+value.primary+value.secondary+'">';var median_price=0;"BTS"===value.primary?(median_price=data[value.secondary].median_price,precision=currencyIsoCodes[value.primary].decimal_digits):"BTS"===value.secondary?(median_price=1/data[value.primary].median_price,precision=currencyIsoCodes[value.secondary].decimal_digits):data[value.primary]&&data[value.secondary]&&(median_price=data[value.secondary].median_price/data[value.primary].median_price);var open_price=0;"BTS"===value.primary?open_price=data[value.secondary].open_price:"BTS"===value.secondary?open_price=1/data[value.primary].open_price:data[value.primary]&&data[value.secondary]&&(open_price=data[value.secondary].open_price/data[value.primary].open_price);var difference=0,pct=0;open_price>0&&median_price>0&&(difference=median_price-open_price,pct=round10(100*(difference/open_price),2));var symbol="";isoCodeMap&&(symbol=isoCodeMap.symbol),build+=value.primary+"/"+value.secondary+" "+symbol+'<b id="value">'+round10(median_price,precision)+"</b>",difference>0?build+='<b class="up">&nbsp;<b class="change">&nbsp;'+round10(difference,precision)+'</b><b class="pct">&nbsp;('+pct+'%)</b>&nbsp;<i class="fa fa-caret-up"></i></b>':0>difference&&(build+='<b class="down">&nbsp;<b class="change">&nbsp;'+round10(difference,precision)+'</b><b class="pct">&nbsp;('+pct+'%)</b>&nbsp;<i class="fa fa-caret-down"></i></b>'),build+="&nbsp;&nbsp;</span>"}),build+="Rates updated every 5 minutes&nbsp;&nbsp;",build+='Powered by <a href="http://bitshares.org" target="_blank">Bitshares.org</a>...&nbsp;&nbsp;</span>',jQuery(build)}function build(){var build="";return build+='<div class="bitsharesticker">',build+='<div class="bitsharesticker-container">',build+='<div class="bitsharesticker-container-left"></div>',build+='<div class="bitsharesticker-container-content">',build+='<div class="bitsharesticker-username"><a href="#">Bitshares Ticker</a></div>',build+='<div class="bitsharesticker-bitshares-link"><a href="http://bitshares.org" target="_blank">Bitshares.org</a></div>',build+='<div class="bitsharesticker-feedbox">',build+='<div class="bitsharesticker-feedbox-content">',build+='<div class="bitsharesticker-replace"></div>',build+="</div>",build+="</div>",build+="</div>",build+='<div class="bitsharesticker-container-right"></div>',build+="</div>",build+="</div>",jQuery(build)}var bitsharesticker,feedsList,overflowContainer,currencyIsoCodes=null,options=jQuery.extend({},jQuery.fn.bitsharesticker.defaults,options),currentRate=options.normalRate,currencyUniqueList="",currencyMap=buildCurrencyMap(),firstLoadUpdateInterval=5,firstLoad=!0;return this.each(function(){bitsharesticker=0==options.tickerOnly?build():jQuery('<div class="bitsharesticker"><div class="bitsharesticker-replace"></div></div>'),jQuery(this).append(bitsharesticker);var text="Loading... Please wait.";feedsList=jQuery('<ul class="bitsharesticker-feeds-list"><li class="bitsharesticker-feed">'+text+"</li></ul>"),overflowContainer=jQuery('<div class="bitsharesticker-overflow-container"></div>'),bitsharesticker.find("div.bitsharesticker-username a").attr("href","http://bitshares.org").html(options.title),overflowContainer.wrapInner(feedsList),bitsharesticker.find("div.bitsharesticker-replace").replaceWith(overflowContainer),overflowContainer.mouseover(function(){currentRate=options.hoverRate}),overflowContainer.mouseout(function(){currentRate=options.normalRate}),feedsList.css("left",overflowContainer.width()),animationLoop(),getCurrencyCodes()})},jQuery.fn.bitsharesticker.defaults={title:"",normalRate:15,hoverRate:100,tickerOnly:!1,source:"",currencyTemplateSource:"",currencyPrimary:"",currencySecondary:"",updateInterval:300}}(jQuery);var globalNeedScan=!0,globalPaid=!1,globalPaymentTimer=null,globalScanInProgress=!1,globalRedirectCountdownTimer=null,globalInitDialog=null,globalRedirectDialog=null,globalLoadingDialog=null,globalAmountReceived=0,globalTotal=0,globalAsset="";